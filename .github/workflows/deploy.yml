name: üöÄ Deploy Chacharitas to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_AUTH_SOCK: /tmp/ssh_agent.sock

    steps:
      # 1) Checkout del c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Configurar SSH Agent con passphrase
      - name: Setup SSH agent with passphrase
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          # Inicia el agente en el socket definido
          ssh-agent -a "$SSH_AUTH_SOCK" > /dev/null

          # Crea un peque√±o helper que devuelva la passphrase
          echo 'echo $SSH_PASSPHRASE' > ~/.ssh_askpass
          chmod +x ~/.ssh_askpass

          # A√±ade tu clave al agente usando SSH_ASKPASS
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' \
            | DISPLAY=none SSH_ASKPASS=~/.ssh_askpass ssh-add - > /dev/null

          # Comprueba que qued√≥ cargada
          ssh-add -l

          # Guarda la huella de tu host para no preguntar luego
          mkdir -p ~/.ssh
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      # 3) Conectar por SSH y desplegar
      - name: SSH Deploy Laravel Application
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            
            # Variables de configuraci√≥n
            APP_DIR="/var/www/html/chacharitas"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "üöÄ Iniciando deployment de Chacharitas..."
            
            # Crear backup si existe la aplicaci√≥n
            if [ -d "$APP_DIR" ]; then
              echo "üì¶ Creando backup..."
              mkdir -p $HOME/backups/chacharitas
              cp -r $APP_DIR $HOME/backups/chacharitas/backup_$TIMESTAMP
              echo "‚úÖ Backup creado en $HOME/backups/chacharitas/backup_$TIMESTAMP"
            fi
            
            # Navegar al directorio de la aplicaci√≥n
            cd $APP_DIR
            
            # Poner la aplicaci√≥n en modo mantenimiento
            echo "üîß Activando modo mantenimiento..."
            php artisan down --retry=60 || true
            
            # Actualizar c√≥digo desde Git
            echo "üì• Actualizando c√≥digo desde repositorio..."
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            
            # Instalar dependencias de Composer
            echo "üì¶ Instalando dependencias de PHP..."
            composer install --optimize-autoloader --no-dev --no-interaction
            
            # Instalar dependencias de Node.js y compilar assets
            if [ -f "package.json" ]; then
              echo "üì¶ Instalando dependencias de Node.js..."
              npm ci
              
              echo "üèóÔ∏è Compilando assets..."
              npm run build
              
              echo "üßπ Limpiando node_modules de desarrollo..."
              npm ci --omit=dev
            fi
            
            # Configurar permisos de forma segura
            echo "üîê Configurando permisos..."
            
            # Solo cambiar permisos de archivos que el usuario deploy puede modificar
            find $APP_DIR -type f -user deploy -exec chmod 644 {} \;
            find $APP_DIR -type d -user deploy -exec chmod 755 {} \;
            
            # Para storage y cache, usar sudo solo si es necesario
            if [ -w "$APP_DIR/storage" ]; then
              chmod -R 775 $APP_DIR/storage $APP_DIR/bootstrap/cache 2>/dev/null || true
            else
              echo "‚ö†Ô∏è  Algunos archivos en storage requieren permisos de administrador..."
              sudo chmod -R 775 $APP_DIR/storage $APP_DIR/bootstrap/cache || true
            fi
            
            # Asegurar que www-data tenga acceso a storage y cache
            sudo chgrp -R www-data $APP_DIR/storage $APP_DIR/bootstrap/cache
            
            # Limpiar cach√© antes de los comandos
            echo "üßπ Limpiando cach√©..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            
            # Ejecutar migraciones
            echo "üóÑÔ∏è Ejecutando migraciones..."
            php artisan migrate --force
            
            # Crear cach√© optimizado
            echo "‚ö° Creando cach√© optimizado..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Reiniciar servicios
            echo "üîÑ Reiniciando servicios..."
            sudo systemctl restart php8.2-fpm
            sudo nginx -t && sudo systemctl reload nginx
            
            # Desactivar modo mantenimiento
            echo "‚úÖ Desactivando modo mantenimiento..."
            php artisan up
            
            echo "üéâ Deployment completado exitosamente!"
            echo "üåê Chacharitas est√° disponible en https://chacharitas.org"
          EOF
